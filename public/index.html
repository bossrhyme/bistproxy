<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DeepFin- Hisse Tarama AracÄ± </title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#0b0e13;--s1:#111519;--s2:#161b22;--s3:#0d1117;
  --border:#1e2733;--border2:#263040;
  --green:#00c076;--green2:#00a060;--green-bg:rgba(0,192,118,.08);
  --red:#f6465d;--red-bg:rgba(246,70,93,.08);
  --blue:#3b82f6;--blue2:#2563d4;
  --gold:#f0b429;--text:#e2e8f0;--text2:#94a3b8;--muted:#4a5568;--muted2:#64748b;
  --accent:#3b82f6;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,sans-serif;}

/* â”€â”€ API KEY SETUP SCREEN â”€â”€ */
#setup{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:100;background:var(--bg);}
.sbox{position:relative;width:460px;background:var(--s1);border:1px solid var(--border2);box-shadow:0 20px 60px rgba(0,0,0,.5);padding:40px;border-radius:12px;}
.slogo{font-size:24px;font-weight:800;color:var(--text);letter-spacing:-.5px;display:flex;align-items:center;gap:10px;}
.slogo-icon{width:36px;height:36px;background:var(--accent);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#fff;}
.slogo span{color:var(--text2);font-weight:400;font-size:22px;}
.ssub{font-size:13px;color:var(--muted2);margin-bottom:28px;margin-top:8px;}
.ssteps{margin-bottom:28px;}
.sstep{display:flex;gap:12px;margin-bottom:14px;align-items:flex-start;}
.sstep-num{font-family:'Inter',sans-serif;font-weight:800;font-size:18px;color:var(--gold);width:22px;flex-shrink:0;line-height:1.3;}
.sstep-txt{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2);line-height:1.7;}
.sstep-txt a{color:var(--teal);text-decoration:none;}
.sstep-txt a:hover{text-decoration:underline;}
.sstep-txt strong{color:var(--text);}
.slabel{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px;}
.sinput-wrap{display:flex;gap:8px;}
.sinput{flex:1;background:var(--s2);border:1px solid var(--border2);color:var(--text);padding:10px 14px;font-size:13px;outline:none;transition:all .15s;border-radius:6px;}
.sinput:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.15);}
.sinput::placeholder{color:var(--muted);letter-spacing:0;}
.sbtn{background:var(--accent);color:#fff;border:none;padding:10px 20px;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap;border-radius:6px;}
.sbtn:hover{background:var(--blue2);}
.serr{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--red);min-height:16px;margin-top:10px;}
.sfree{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);margin-top:18px;padding-top:14px;border-top:1px solid var(--border);line-height:1.7;}
.sfree strong{color:var(--teal);}

/* â”€â”€ APP â”€â”€ */
#app{display:flex;flex-direction:column;height:100vh;position:relative;z-index:1;}


/* â”€â”€ TOPBAR â”€â”€ */
.topbar{display:flex;align-items:center;padding:0 16px;height:48px;border-bottom:1px solid var(--border);background:var(--s1);flex-shrink:0;gap:10px;z-index:10;}
.tlogo{font-size:15px;font-weight:700;color:var(--text);white-space:nowrap;letter-spacing:-.3px;display:flex;align-items:center;gap:6px;}
.tlogo-mark{width:22px;height:22px;background:var(--accent);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;}
.tlogo span{color:var(--text2);font-weight:400;font-size:13px;}
.tlive{font-size:10px;color:var(--green);background:var(--green-bg);border:1px solid rgba(0,192,118,.2);padding:2px 8px;border-radius:4px;font-weight:500;display:flex;align-items:center;gap:4px;}
.tlive::before{content:'';width:5px;height:5px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.tsearch{position:relative;flex:1;max-width:320px;}
.tsearch input{width:100%;background:var(--s2);border:1px solid var(--border);color:var(--text);padding:6px 12px 6px 32px;font-size:12px;outline:none;transition:border-color .15s;border-radius:6px;}
.tsearch input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.15);}
.tsearch input::placeholder{color:var(--muted2);}
.tsearch-ico{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted2);font-size:13px;pointer-events:none;}
.tright{margin-left:auto;display:flex;align-items:center;gap:6px;}
.topbarbtn{font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;white-space:nowrap;display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:6px;}
.tbtn{background:var(--accent);color:#fff;border:none;font-weight:600;}
.tbtn:hover{background:var(--blue2);}
.tbtn:disabled{opacity:.4;cursor:not-allowed;}
.infobtn{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.infobtn:hover{border-color:var(--accent);color:var(--accent);background:rgba(59,130,246,.05);}
.supportbtn{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.supportbtn:hover{border-color:var(--gold);color:var(--gold);}
#scantime{font-size:11px;color:var(--muted2);}

/* â”€â”€ LAYOUT â”€â”€ */
.layout{display:flex;flex:1;overflow:hidden;}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{width:248px;min-width:248px;border-right:1px solid var(--border);overflow-y:auto;background:var(--s1);padding:12px 10px;}
.sidebar::-webkit-scrollbar{width:3px;}
.sidebar::-webkit-scrollbar-thumb{background:var(--border2);}
.stitle{font-size:10px;font-weight:600;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;}
.filter-group{margin-bottom:14px;}
.filter-group-title{font-size:10px;font-weight:600;color:var(--muted2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:7px;display:flex;align-items:center;gap:6px;}
.filter-group-title::after{content:'';flex:1;height:1px;background:var(--border);}
.chips{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px;}
.chip{font-size:11px;font-weight:500;padding:3px 9px;border:1px solid var(--border2);color:var(--text2);cursor:pointer;transition:all .12s;user-select:none;border-radius:4px;background:var(--s2);}
.chip:hover{border-color:var(--accent);color:var(--accent);background:rgba(59,130,246,.06);}
.chip.on{border-color:var(--accent);color:#fff;background:var(--accent);}
.goat-chip{border-color:rgba(240,180,41,.3);color:var(--gold);background:rgba(240,180,41,.06);border-radius:4px;}
.goat-chip:hover{border-color:var(--gold);background:rgba(240,180,41,.12);}
.goat-chip.on{border-color:var(--gold);color:#000;background:var(--gold);}
.goat-info{display:none;margin-top:7px;font-size:10px;color:var(--text2);line-height:1.6;padding:8px 10px;background:rgba(240,180,41,.06);border-left:2px solid var(--gold);border-radius:0 4px 4px 0;}
.presets{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px;}
.fblock{margin-bottom:12px;}
.fbtitle{font-size:10px;font-weight:600;color:var(--muted2);letter-spacing:.3px;margin-bottom:6px;}
.frow{margin-bottom:5px;}
.flbl{font-size:10px;color:var(--text2);margin-bottom:3px;display:flex;justify-content:space-between;font-weight:500;}
.flbl small{font-size:9px;color:var(--muted2);}
.finps{display:flex;gap:4px;}
.finps input{flex:1;min-width:0;background:var(--s2);border:1px solid var(--border);color:var(--text);padding:5px 8px;font-size:11px;outline:none;transition:all .12s;border-radius:5px;}
.finps input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.12);}
.finps input::placeholder{color:var(--muted2);}
.clrbtn{width:100%;background:transparent;border:1px solid var(--border);color:var(--text2);padding:6px;font-size:11px;cursor:pointer;transition:all .15s;margin-top:4px;border-radius:5px;font-weight:500;}
.clrbtn:hover{border-color:var(--red);color:var(--red);background:var(--red-bg);}

/* â”€â”€ CONTENT â”€â”€ */
.content{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.toolbar{padding:6px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:var(--s2);flex-shrink:0;}
.rcount strong{font-size:18px;font-weight:700;color:var(--text);}
.rcount span{font-size:11px;color:var(--muted2);margin-left:4px;}
.pbar{height:2px;background:var(--border);flex:1;overflow:hidden;border-radius:2px;}
.pbarfill{height:100%;background:var(--accent);width:0%;transition:width .2s;border-radius:2px;}
.ssel{background:var(--s1);border:1px solid var(--border);color:var(--text);padding:4px 8px;font-size:11px;outline:none;cursor:pointer;border-radius:5px;}

/* â”€â”€ STATES â”€â”€ */
.cstate{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;}
.cstate .big{font-size:48px;font-weight:800;color:var(--border);letter-spacing:-2px;line-height:1;}
.cstate p{font-size:13px;color:var(--muted2);text-align:center;max-width:400px;line-height:1.6;}
.cstate small{font-size:11px;color:var(--muted);}
.spinner{width:24px;height:24px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ TABLE â”€â”€ */
.twrap{flex:1;overflow:auto;}
.twrap::-webkit-scrollbar{width:5px;height:5px;}
.twrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
thead{position:sticky;top:0;z-index:5;}
thead th{background:var(--s2);color:var(--muted2);font-size:11px;font-weight:600;padding:8px 10px;text-align:right;border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none;letter-spacing:0;}
thead th:first-child,thead th:nth-child(2){text-align:left;}
thead th:hover{color:var(--text);}
thead th.sorted{color:var(--accent);}
thead th.sorted::after{content:' â†“';font-size:9px;}
thead th.sorted.asc::after{content:' â†‘';}
tbody tr{transition:background .08s;cursor:pointer;}tbody tr:nth-child(even){background:rgba(255,255,255,.015);}
tbody tr:hover{background:rgba(59,130,246,.04);}
tbody tr.selrow{background:rgba(59,130,246,.07);border-left:2px solid var(--accent);}
td{padding:6px 10px;text-align:right;font-size:12px;white-space:nowrap;color:var(--text);border-bottom:1px solid rgba(30,39,51,.7);}
td:first-child,td:nth-child(2){text-align:left;}
.sym{font-size:12px;font-weight:700;color:var(--text);letter-spacing:0;}
.nmc{color:var(--muted2);font-size:11px;max-width:130px;overflow:hidden;text-overflow:ellipsis;font-weight:400;}
.up{color:var(--green);}
.dn{color:var(--red);}
.nil{color:var(--muted);}
.bdg{display:inline-block;padding:1px 6px;font-size:10px;font-weight:600;border-radius:4px;}
.bbuy{background:var(--green-bg);color:var(--green);}
.bhold{background:rgba(240,180,41,.08);color:var(--gold);}
.bsell{background:var(--red-bg);color:var(--red);}

/* â”€â”€ DETAIL PANEL â”€â”€ */
.detail{width:0;min-width:0;border-left:1px solid var(--border);background:var(--s1);overflow:hidden;transition:width .2s,min-width .2s;flex-shrink:0;}
.detail.open{width:360px;min-width:360px;overflow-y:auto;}
.detail::-webkit-scrollbar{width:3px;}
.detail::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.dhead{padding:14px 16px;border-bottom:1px solid var(--border);position:relative;background:var(--s2);}
.dsym{font-size:22px;font-weight:800;color:var(--text);letter-spacing:-.5px;line-height:1;}
.dname{font-size:11px;color:var(--muted2);margin-top:2px;font-weight:400;}
.dclose{position:absolute;top:12px;right:12px;background:var(--border);border:none;color:var(--text2);font-size:14px;cursor:pointer;width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;}
.dclose:hover{background:var(--red-bg);color:var(--red);}
.dprice{font-size:26px;font-weight:800;padding:10px 16px 2px;letter-spacing:-.5px;}
.dchg{font-size:11px;padding:0 16px 6px;font-weight:500;}
.dsec{font-size:10px;color:var(--muted2);padding:0 16px 10px;border-bottom:1px solid var(--border);}
.dsection{padding:10px 16px;border-bottom:1px solid var(--border);}
.dstitle{font-size:10px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;}
.drow{display:flex;justify-content:space-between;margin-bottom:5px;align-items:center;padding:2px 0;}
.drow:hover{background:rgba(255,255,255,.02);margin:0 -4px 3px;padding:2px 4px;border-radius:4px;}
.dkey{font-size:11px;color:var(--muted2);font-weight:400;}
.dkey tag{font-size:9px;color:var(--muted);background:var(--s2);padding:1px 4px;border-radius:3px;margin-left:4px;font-weight:500;}
.dval{font-size:12px;font-weight:600;}
.dfresh{font-size:10px;color:var(--muted2);padding:4px 16px 8px;border-bottom:1px solid var(--border);}
.chart-section{padding:10px 12px;border-bottom:1px solid var(--border);}
.chart-tabs{display:flex;gap:2px;margin-bottom:6px;flex-wrap:wrap;background:var(--s2);padding:3px;border-radius:6px;}
.ctab{font-size:10px;font-weight:500;padding:3px 9px;color:var(--muted2);cursor:pointer;border-radius:4px;transition:all .12s;user-select:none;border:none;background:none;}
.ctab:hover{color:var(--text);}
.ctab.on{background:var(--s1);color:var(--text);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.3);}
.ctab-cur{font-size:10px;font-weight:500;padding:3px 9px;color:var(--muted2);cursor:pointer;border-radius:4px;transition:all .12s;user-select:none;border:none;background:none;}
.ctab-cur:hover{color:var(--text);}
.ctab-cur.on{background:var(--s1);color:var(--text);font-weight:600;box-shadow:0 1px 3px rgba(0,0,0,.3);}
.itab{font-size:10px;font-weight:500;padding:2px 7px;border:1px solid var(--border);color:var(--muted2);cursor:pointer;border-radius:4px;transition:all .12s;user-select:none;}
.itab:hover{border-color:var(--accent);color:var(--accent);}
.itab.on{background:rgba(59,130,246,.1);color:var(--accent);border-color:var(--accent);}
.chart-wrap{width:100%;height:260px;background:var(--bg);border:1px solid var(--border);overflow:hidden;position:relative;display:flex;}
.chart-toolbar{width:28px;min-width:28px;background:var(--s2);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:4px 0;gap:2px;z-index:10;}
.ctool{width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:3px;color:var(--muted2);font-size:13px;transition:all .15s;position:relative;}
.ctool:hover{background:rgba(15,240,179,.08);color:var(--teal);}
.ctool.on{background:rgba(15,240,179,.15);color:var(--teal);}
.ctool-sep{width:18px;height:1px;background:var(--border);margin:3px 0;}
.ctool-tip{position:absolute;left:30px;top:50%;transform:translateY(-50%);background:#1c2d40;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:9px;padding:3px 7px;border-radius:3px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:100;border:1px solid var(--border2);}
.ctool:hover .ctool-tip{opacity:1;}
#tv-chart-container{flex:1;height:100%;min-width:0;}
.chart-wrap.expanded{height:420px;}
.expand-btn{position:absolute;top:4px;right:4px;z-index:20;background:rgba(13,17,23,.8);border:1px solid var(--border2);color:var(--muted2);width:20px;height:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px;border-radius:2px;}
.expand-btn:hover{color:var(--teal);border-color:var(--teal);}
.fib-panel{display:none;position:absolute;right:0;top:0;bottom:0;width:110px;background:rgba(10,15,24,.92);border-left:1px solid var(--border);z-index:15;padding:8px 6px;overflow-y:auto;}
.fib-panel.show{display:block;}
.fib-title{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--teal);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;}
.fib-row{display:flex;justify-content:space-between;margin-bottom:3px;}
.fib-level{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);}
.fib-price{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--text);}
.fib-inputs{margin-bottom:8px;}
.fib-inp{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:3px 5px;font-family:'JetBrains Mono',monospace;font-size:9px;margin-bottom:3px;outline:none;}
.fib-inp:focus{border-color:var(--teal);}
.fib-calc-btn{width:100%;background:var(--teal);color:#000;border:none;padding:4px;font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;font-weight:700;margin-bottom:6px;}

/* â”€â”€ INFO MODAL â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{position:relative;width:900px;max-width:96vw;max-height:88vh;background:var(--s1);border:1px solid var(--border);box-shadow:0 25px 60px rgba(0,0,0,.6);display:flex;flex-direction:column;overflow:hidden;border-radius:10px;}

.modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 22px 14px;border-bottom:1px solid var(--border);flex-shrink:0;}
.modal-title{font-size:17px;font-weight:700;color:var(--text);letter-spacing:-.3px;}
.modal-title span{color:var(--text2);font-weight:400;}
.modal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;}
.modal-close:hover{color:var(--red);}
.modal-body{overflow-y:auto;padding:22px;display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.modal-body::-webkit-scrollbar{width:4px;}
.modal-body::-webkit-scrollbar-thumb{background:var(--border2);}
.icat{background:var(--s2);border:1px solid var(--border);padding:16px 18px;border-radius:8px;}
.icat-title{font-size:12px;font-weight:700;color:var(--text);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;padding-bottom:7px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.iitem{margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid rgba(28,45,64,.5);}
.iitem:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none;}
.iitem-top{display:flex;align-items:baseline;gap:8px;margin-bottom:4px;}
.iitem-name{font-size:14px;font-weight:700;color:var(--text);letter-spacing:-.3px;}
.iitem-eng{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.iitem-desc{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted2);line-height:1.65;}
.iitem-tip{display:inline-block;margin-top:5px;font-family:'JetBrains Mono',monospace;font-size:8px;padding:2px 8px;}
.tip-good{background:rgba(15,240,179,.08);color:var(--teal);border:1px solid rgba(15,240,179,.2);}
.tip-warn{background:rgba(240,192,64,.08);color:var(--gold);border:1px solid rgba(240,192,64,.2);}
.tip-bad{background:rgba(255,77,109,.08);color:var(--red);border:1px solid rgba(255,77,109,.2);}
.preset-info-wrap{grid-column:1/-1;}
.preset-info-title{font-family:'Inter',sans-serif;font-weight:800;font-size:12px;letter-spacing:3px;color:var(--teal);margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--border);}
.preset-info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;}
.picard{background:var(--s2);border:1px solid var(--border);padding:12px 14px;}
.picard-name{font-family:'Inter',sans-serif;font-weight:800;font-size:12px;letter-spacing:2px;color:var(--gold);margin-bottom:5px;}
.picard-desc{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted2);line-height:1.6;}
.picard-rules{margin-top:7px;display:flex;flex-wrap:wrap;gap:3px;}
.picard-rule{font-family:'JetBrains Mono',monospace;font-size:8px;padding:2px 6px;background:rgba(15,240,179,.06);color:var(--teal);border:1px solid rgba(15,240,179,.15);}

/* â”€â”€ SUPPORT MODAL â”€â”€ */
.smodal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:300;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.smodal-overlay.open{display:flex;}
.smodal{position:relative;width:540px;max-width:96vw;background:var(--s1);border:1px solid var(--border2);box-shadow:0 0 80px rgba(240,192,64,.1);overflow:hidden;}
.smodal::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--gold),#f08020,var(--teal));}
.smodal-head{padding:26px 26px 0;display:flex;justify-content:space-between;}
.smodal-close{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;line-height:1;}
.smodal-close:hover{color:var(--red);}
.smodal-hero{padding:16px 26px 20px;border-bottom:1px solid var(--border);}
.smodal-emoji{font-size:36px;margin-bottom:10px;display:block;}
.smodal-title{font-family:'Inter',sans-serif;font-weight:800;font-size:26px;letter-spacing:4px;color:var(--gold);line-height:1.1;margin-bottom:9px;}
.smodal-desc{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted2);line-height:1.75;}
.smodal-desc strong{color:var(--text);}
.smodal-options{padding:20px 26px;}
.smodal-options-title{font-family:'Inter',sans-serif;font-weight:800;font-size:10px;letter-spacing:3px;color:var(--muted);margin-bottom:14px;text-transform:uppercase;}
.soption{background:var(--s2);border:1px solid var(--border);padding:14px 16px;margin-bottom:10px;}
.soption:last-child{margin-bottom:0;}
.soption-head{display:flex;align-items:center;gap:9px;margin-bottom:9px;}
.soption-icon{font-size:18px;}
.soption-label{font-family:'Inter',sans-serif;font-weight:800;font-size:13px;letter-spacing:2px;color:var(--text);}
.soption-sublabel{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--muted);margin-top:1px;}
.bmc-link{display:flex;align-items:center;gap:9px;background:linear-gradient(135deg,#f0c040,#e08010);color:#000;padding:10px 15px;text-decoration:none;font-family:'Inter',sans-serif;font-weight:800;font-size:13px;letter-spacing:2px;transition:all .2s;width:100%;}
.bmc-link:hover{box-shadow:0 0 20px rgba(240,192,64,.4);transform:translateY(-1px);}
.wallet-row{display:flex;align-items:center;gap:7px;margin-bottom:7px;}
.wallet-row:last-child{margin-bottom:0;}
.wallet-coin{font-family:'Inter',sans-serif;font-weight:800;font-size:11px;letter-spacing:1px;color:var(--gold);width:34px;flex-shrink:0;}
.wallet-addr{flex:1;background:var(--bg);border:1px solid var(--border);padding:6px 9px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:text;user-select:all;}
.copy-btn{background:var(--border2);border:none;color:var(--muted2);padding:6px 9px;font-family:'JetBrains Mono',monospace;font-size:8px;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;}
.copy-btn:hover,.copy-btn.copied{background:var(--teal);color:#000;}
.smodal-thanks{padding:0 26px 20px;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--muted);text-align:center;line-height:1.7;}
.smodal-thanks strong{color:var(--teal);}
</style>
<script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>

<!-- â”€â”€â”€ MAIN APP â”€â”€â”€ -->
<div id="app" class="on">
  <div class="topbar">
    <div class="tlogo">DeepFin</span></div>
    <span class="tlive">CANLI</span>
    <div class="tsearch">
      <span class="tsearch-ico">âŒ•</span>
      <input type="text" id="searchbox" placeholder="Sembol veya ÅŸirket ara..." oninput="onSearch()"/>
    </div>
    <div class="tright">
      <span id="scantime"></span>
      <button class="topbarbtn tbtn" id="scanbtn" onclick="runScan()">â–¶ TARA</button>
      <button class="topbarbtn" id="stopbtn" onclick="abortScan()" style="display:none;background:rgba(255,77,109,.15);border:1px solid rgba(255,77,109,.3);color:var(--red)">â¹ DURDUR</button>
      <button class="topbarbtn infobtn" onclick="openInfo()">ğŸ“š Bilgi</button>
      <button class="topbarbtn supportbtn" onclick="openSupport()">â˜•</button>
      
    </div>
  </div>

  <div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar">

      <div class="filter-group">
        <div class="filter-group-title">ğŸ GOAT Stratejileri</div>
        <div class="chips" id="goat-chips">
          <div class="chip goat-chip" data-goat="buffett">Buffett</div>
          <div class="chip goat-chip" data-goat="graham">Graham</div>
          <div class="chip goat-chip" data-goat="lynch">Lynch</div>
          <div class="chip goat-chip" data-goat="ark">Ark/Wood</div>
          <div class="chip goat-chip" data-goat="minervini">Minervini</div>
        </div>
        <div class="goat-info" id="goat-info"></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">HazÄ±r Filtreler</div>
        <div class="presets chips" id="presets">
          <div class="chip" data-preset="value">DeÄŸer</div>
          <div class="chip" data-preset="growth">BÃ¼yÃ¼me</div>
          <div class="chip" data-preset="dividend">TemettÃ¼</div>
          <div class="chip" data-preset="quality">Kaliteli</div>
          <div class="chip" data-preset="lowdebt">Az BorÃ§</div>
          <div class="chip" data-preset="momentum">Momentum</div>
        </div>
        <div class="goat-info" id="preset-info"></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">DeÄŸerleme</div>
        <div class="frow"><div class="flbl">F/K <small>min / max</small></div><div class="finps"><input type="number" id="pe_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="pe_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">PD/DD</div><div class="finps"><input type="number" id="pb_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="pb_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">F/S</div><div class="finps"><input type="number" id="ps_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="ps_max" placeholder="â€”" oninput="liveFilter()"></div></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">KarlÄ±lÄ±k</div>
        <div class="frow"><div class="flbl">ROE %</div><div class="finps"><input type="number" id="roe_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="roe_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">ROA %</div><div class="finps"><input type="number" id="roa_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="roa_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">Net Marj %</div><div class="finps"><input type="number" id="margin_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="margin_max" placeholder="â€”" oninput="liveFilter()"></div></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">BÃ¼yÃ¼me</div>
        <div class="frow"><div class="flbl">Gelir BÃ¼y. %</div><div class="finps"><input type="number" id="revg_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="revg_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">KazanÃ§ BÃ¼y. %</div><div class="finps"><input type="number" id="earng_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="earng_max" placeholder="â€”" oninput="liveFilter()"></div></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">TemettÃ¼ & SaÄŸlÄ±k</div>
        <div class="frow"><div class="flbl">TemettÃ¼ %</div><div class="finps"><input type="number" id="div_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="div_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">BorÃ§/Ã–zkaynak</div><div class="finps"><input type="number" id="de_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="de_max" placeholder="â€”" oninput="liveFilter()"></div></div>
        <div class="frow"><div class="flbl">Cari Oran</div><div class="finps"><input type="number" id="cr_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="cr_max" placeholder="â€”" oninput="liveFilter()"></div></div>
      </div>

      <div class="filter-group">
        <div class="filter-group-title">Piyasa</div>
        <div class="frow"><div class="flbl">Piyasa DeÄŸeri (Mn)</div><div class="finps"><input type="number" id="mc_min" placeholder="â€”" oninput="liveFilter()"><input type="number" id="mc_max" placeholder="â€”" oninput="liveFilter()"></div></div>
      </div>

      <button class="clrbtn" onclick="clearFilters()">âœ• Filtreleri Temizle</button>
    </div>

    <!-- CONTENT -->
    <div class="content">
      <div class="toolbar" id="toolbar" style="display:none">
        <div class="rcount"><strong id="resn">0</strong><span> / <span id="scann">0</span> hisse</span></div>
        <div class="pbar"><div class="pbarfill" id="prog"></div></div>
        <select class="ssel" id="sortf" onchange="onSortChange()">
          <option value="marketCapitalization">Piyasa DeÄŸeri</option>
          <option value="peNormalizedAnnual">F/K</option>
          <option value="pbAnnual">PD/DD</option>
          <option value="roeTTM">ROE</option>
          <option value="roaTTM">ROA</option>
          <option value="netProfitMarginTTM">Kar MarjÄ±</option>
          <option value="dividendYieldIndicatedAnnual">TemettÃ¼</option>
          <option value="revenueGrowthTTMYoy">Gelir BÃ¼yÃ¼mesi</option>
          <option value="currentRatioAnnual">Cari Oran</option>
        </select>
        <select class="ssel" id="sortd" onchange="onSortChange()">
          <option value="desc">â†“ Azalan</option>
          <option value="asc">â†‘ Artan</option>
        </select>
      </div>

      <div class="cstate" id="empty">
        <div class="big">BIST</div>
        <p>API baÄŸlandÄ±. Filtreleri ayarlayÄ±n ve <strong>â–¶ TARA</strong> butonuna tÄ±klayÄ±n.</p>
        <small id="empty-sub">Finnhub'dan canlÄ± veri Ã§ekilecek</small>
      </div>
      <div class="cstate" id="loading" style="display:none">
        <div class="spinner"></div>
        <p id="loadtxt">Veriler yÃ¼kleniyor...</p>
        <small id="loadsub"></small>
      </div>
      <div class="cstate" id="errstate" style="display:none">
        <div class="big" style="color:var(--red)">HATA</div>
        <p id="errmsg" style="color:var(--red)"></p>
        
      </div>

      <div class="twrap" id="twrap" style="display:none">
        <table>
          <thead>
            <tr>
              <th onclick="colSort('symbol')">SEMBOL</th>
              <th onclick="colSort('name')">ÅÄ°RKET</th>
              <th onclick="colSort('currentPrice')">FÄ°YAT</th>
              <th onclick="colSort('changePercent')">DEÄ%</th>
              <th onclick="colSort('marketCapitalization')">PD (Mn)</th>
              <th onclick="colSort('peNormalizedAnnual')">F/K</th>
              <th onclick="colSort('pbAnnual')">PD/DD</th>
              <th onclick="colSort('psTTM')">F/S</th>
              <th onclick="colSort('roeTTM')">ROE%</th>
              <th onclick="colSort('roaTTM')">ROA%</th>
              <th onclick="colSort('netProfitMarginTTM')">MARJ%</th>
              <th onclick="colSort('revenueGrowthTTMYoy')">GELÄ°Râ†‘%</th>
              <th onclick="colSort('epsGrowthTTMYoy')">K.BÃœY%</th>
              <th onclick="colSort('dividendYieldIndicatedAnnual')">TEMETTÃœ%</th>
              <th onclick="colSort('totalDebt/totalEquityAnnual')">B/Ã–</th>
              <th onclick="colSort('currentRatioAnnual')">CARÄ°</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DETAIL PANEL -->
    <div class="detail" id="detail">
      <div class="dhead">
        <button class="dclose" onclick="closeDetail()">âœ•</button>
        <div class="dsym" id="dsym">â€”</div>
        <div class="dname" id="dname">â€”</div>
      </div>
      <div class="dprice" id="dprice">â€”</div>
      <div class="dchg" id="dchg"></div>
      <div class="dfresh" id="dfresh"></div>
      <div class="dsec" id="dsec">â€”</div>
      <div class="chart-section">
        <div class="chart-tabs" id="chart-tabs">
          <div class="ctab on" data-interval="240">4S</div>
          <div class="ctab" data-interval="D">1G</div>
          <div class="ctab" data-interval="W">1H</div>
          <div class="ctab-cur on" data-currency="TL">â‚º</div>
          <div class="ctab-cur" data-currency="USD">$</div>
        </div>
        <div class="chart-tabs" id="ind-tabs" style="margin-bottom:6px;">
          <div class="itab" data-ind="MA20">MA20</div>
          <div class="itab" data-ind="MA50">MA50</div>
          <div class="itab" data-ind="EMA20">EMA20</div>
          <div class="itab" data-ind="BB">BB</div>
          <div class="itab" data-ind="VOL">Hacim</div>
        </div>
        <div class="chart-wrap" id="chart-wrap">
          <div class="chart-toolbar" id="chart-toolbar">
            <div class="ctool on" data-tool="cursor" title="">
              <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M2 2l9 4.5-4.5 1L5 12 2 2z" fill="currentColor"/></svg>
              <span class="ctool-tip">Cursor</span>
            </div>
            <div class="ctool-sep"></div>
            <div class="ctool" data-tool="line" title="">
              <svg width="13" height="13" viewBox="0 0 13 13"><line x1="2" y1="11" x2="11" y2="2" stroke="currentColor" stroke-width="1.5"/></svg>
              <span class="ctool-tip">Trend Ã‡izgisi</span>
            </div>
            <div class="ctool" data-tool="hline" title="">
              <svg width="13" height="13" viewBox="0 0 13 13"><line x1="1" y1="6.5" x2="12" y2="6.5" stroke="currentColor" stroke-width="1.5"/></svg>
              <span class="ctool-tip">Yatay Ã‡izgi</span>
            </div>
            <div class="ctool" data-tool="rect" title="">
              <svg width="13" height="13" viewBox="0 0 13 13"><rect x="2" y="3" width="9" height="7" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
              <span class="ctool-tip">DikdÃ¶rtgen</span>
            </div>
            <div class="ctool-sep"></div>
            <div class="ctool" data-tool="fib" title="">
              <svg width="13" height="13" viewBox="0 0 13 13"><line x1="2" y1="3" x2="11" y2="3" stroke="currentColor" stroke-width="1"/><line x1="2" y1="5.5" x2="11" y2="5.5" stroke="#f0c040" stroke-width="1"/><line x1="2" y1="8" x2="11" y2="8" stroke="currentColor" stroke-width="1"/><line x1="2" y1="10" x2="11" y2="10" stroke="currentColor" stroke-width="1"/></svg>
              <span class="ctool-tip">Fibonacci</span>
            </div>
            <div class="ctool-sep"></div>
            <div class="ctool" data-tool="eraser" title="">
              <svg width="13" height="13" viewBox="0 0 13 13"><path d="M2 10L7 3l3 3-5 7H2z" stroke="currentColor" stroke-width="1.2" fill="none"/></svg>
              <span class="ctool-tip">TÃ¼mÃ¼nÃ¼ Sil</span>
            </div>
          </div>
          <div style="position:relative;flex:1;min-width:0;height:100%;">
            <div class="expand-btn" id="expand-btn" onclick="toggleExpand()">â¤¢</div>
            <div id="tv-chart-container" style="height:100%;width:100%;"></div>
            <div class="fib-panel" id="fib-panel">
              <div class="fib-title">Fibonacci</div>
              <div class="fib-inputs">
                <input class="fib-inp" id="fib-high" placeholder="YÃ¼ksek fiyat" type="number">
                <input class="fib-inp" id="fib-low" placeholder="DÃ¼ÅŸÃ¼k fiyat" type="number">
                <button class="fib-calc-btn" onclick="calcFib()">HESAPLA</button>
              </div>
              <div id="fib-results"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="dbody"></div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ INFO MODAL â”€â”€â”€ -->
<div class="modal-overlay" id="infoModal">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-head">
      <div class="modal-title">BÄ°LGÄ° <span>BANKASI</span></div>
      <button class="modal-close" onclick="closeInfo()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="icat">
        <div class="icat-title">ğŸ“Š DeÄŸerleme OranlarÄ±</div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">F/K OranÄ±</span><span class="iitem-eng">P/E â€” Price to Earnings</span></div>
          <div class="iitem-desc">Hisse fiyatÄ±nÄ±n hisse baÅŸÄ±na kÃ¢ra bÃ¶lÃ¼nmesiyle bulunur. YatÄ±rÄ±mcÄ±nÄ±n 1 liralÄ±k kÃ¢r iÃ§in kaÃ§ lira Ã¶dediÄŸini gÃ¶sterir. DÃ¼ÅŸÃ¼k F/K, hissenin ucuz olabileceÄŸine iÅŸaret eder; ancak sektÃ¶re gÃ¶re deÄŸiÅŸir.</div>
          <span class="iitem-tip tip-good">âœ“ 5â€“15 arasÄ± genellikle cazip</span>
          <span class="iitem-tip tip-warn">â–³ 15â€“25 orta deÄŸerli</span>
          <span class="iitem-tip tip-bad">âœ• 25+ pahalÄ± sayÄ±labilir</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">PD/DD</span><span class="iitem-eng">P/B â€” Price to Book Value</span></div>
          <div class="iitem-desc">Piyasa deÄŸerinin defter deÄŸerine oranÄ±dÄ±r. 1'in altÄ±nda defter deÄŸerinin altÄ±nda iÅŸlem gÃ¶rÃ¼yor demektir.</div>
          <span class="iitem-tip tip-good">âœ“ 1'in altÄ± â€” defter deÄŸeri altÄ±nda</span>
          <span class="iitem-tip tip-warn">â–³ 1â€“3 arasÄ± normal</span>
          <span class="iitem-tip tip-bad">âœ• 5+ pahalÄ± olabilir</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">F/S OranÄ±</span><span class="iitem-eng">P/S â€” Price to Sales</span></div>
          <div class="iitem-desc">Piyasa deÄŸerinin yÄ±llÄ±k satÄ±ÅŸ gelirine oranÄ±dÄ±r. KÃ¢r etmeyen ama bÃ¼yÃ¼yen ÅŸirketleri deÄŸerlemek iÃ§in kullanÄ±lÄ±r.</div>
          <span class="iitem-tip tip-good">âœ“ 1'in altÄ± â€” satÄ±ÅŸlara gÃ¶re ucuz</span>
        </div>
      </div>
      <div class="icat">
        <div class="icat-title">ğŸ’° KarlÄ±lÄ±k GÃ¶stergeleri</div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">ROE</span><span class="iitem-eng">Return on Equity â€” Ã–zkaynak KarlÄ±lÄ±ÄŸÄ±</span></div>
          <div class="iitem-desc">Åirketin Ã¶zkaynaklarÄ±nÄ± ne kadar verimli kullandÄ±ÄŸÄ±nÄ± gÃ¶sterir. YÃ¼ksek ROE, ortaklara iyi getiri saÄŸlandÄ±ÄŸÄ± anlamÄ±na gelir.</div>
          <span class="iitem-tip tip-bad">âœ• %10 altÄ± â€” zayÄ±f</span>
          <span class="iitem-tip tip-good">âœ“ %20+ gÃ¼Ã§lÃ¼</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">ROA</span><span class="iitem-eng">Return on Assets â€” VarlÄ±k KarlÄ±lÄ±ÄŸÄ±</span></div>
          <div class="iitem-desc">Åirketin tÃ¼m varlÄ±klarÄ±nÄ± ne kadar verimli kullandÄ±ÄŸÄ±nÄ± gÃ¶sterir. Bankalar iÃ§in genellikle dÃ¼ÅŸÃ¼ktÃ¼r.</div>
          <span class="iitem-tip tip-good">âœ“ %5+ iyi kabul edilir</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">Net Kar MarjÄ±</span><span class="iitem-eng">Profit Margin TTM</span></div>
          <div class="iitem-desc">Her 100 liralÄ±k satÄ±ÅŸtan ne kadar net kÃ¢r kaldÄ±ÄŸÄ±nÄ± gÃ¶sterir. SektÃ¶re gÃ¶re bÃ¼yÃ¼k farklÄ±lÄ±k gÃ¶sterebilir.</div>
          <span class="iitem-tip tip-good">âœ“ %15+ gÃ¼Ã§lÃ¼ marj</span>
        </div>
      </div>
      <div class="icat">
        <div class="icat-title">ğŸ“ˆ BÃ¼yÃ¼me GÃ¶stergeleri</div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">Gelir BÃ¼yÃ¼mesi</span><span class="iitem-eng">Revenue Growth TTM YoY</span></div>
          <div class="iitem-desc">SatÄ±ÅŸ gelirinin geÃ§en yÄ±la gÃ¶re yÃ¼zde kaÃ§ arttÄ±ÄŸÄ±nÄ± gÃ¶sterir. YÃ¼ksek enflasyon ortamÄ±nda reel bÃ¼yÃ¼meye bakmak Ã¶nemlidir.</div>
          <span class="iitem-tip tip-bad">âœ• Negatif â€” gelir dÃ¼ÅŸÃ¼yor</span>
          <span class="iitem-tip tip-good">âœ“ %20+ gÃ¼Ã§lÃ¼ bÃ¼yÃ¼me</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">KazanÃ§ BÃ¼yÃ¼mesi</span><span class="iitem-eng">EPS Growth TTM YoY</span></div>
          <div class="iitem-desc">Hisse baÅŸÄ±na kÃ¢rÄ±n yÄ±ldan yÄ±la ne kadar bÃ¼yÃ¼dÃ¼ÄŸÃ¼nÃ¼ gÃ¶sterir. Gelir bÃ¼yÃ¼mesinden daha Ã¶nemlidir.</div>
          <span class="iitem-tip tip-good">âœ“ %20+ bÃ¼yÃ¼me hisseleri iÃ§in ideal</span>
        </div>
      </div>
      <div class="icat">
        <div class="icat-title">ğŸ¦ TemettÃ¼ ve Finansal SaÄŸlÄ±k</div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">TemettÃ¼ Verimi</span><span class="iitem-eng">Dividend Yield Indicated Annual</span></div>
          <div class="iitem-desc">Hisse baÅŸÄ±na Ã¶denen yÄ±llÄ±k temettÃ¼nÃ¼n mevcut fiyata oranÄ±dÄ±r. SÃ¼rdÃ¼rÃ¼lebilirliÄŸi Ã¶nemlidir.</div>
          <span class="iitem-tip tip-good">âœ“ %4+ temettÃ¼ yatÄ±rÄ±mcÄ±sÄ± iÃ§in cazip</span>
          <span class="iitem-tip tip-warn">â–³ %15+ Ã§ok yÃ¼ksek, risk iÅŸareti olabilir</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">BorÃ§/Ã–zkaynak</span><span class="iitem-eng">Total Debt / Total Equity Annual</span></div>
          <div class="iitem-desc">Åirketin ne kadar borÃ§la Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶sterir. Bankalar iÃ§in bu oran doÄŸal olarak yÃ¼ksektir.</div>
          <span class="iitem-tip tip-good">âœ“ 50'nin altÄ± â€” az borÃ§lu</span>
          <span class="iitem-tip tip-bad">âœ• 200+ yÃ¼ksek borÃ§ yÃ¼kÃ¼</span>
        </div>
        <div class="iitem">
          <div class="iitem-top"><span class="iitem-name">Cari Oran</span><span class="iitem-eng">Current Ratio Annual</span></div>
          <div class="iitem-desc">KÄ±sa vadeli varlÄ±klarÄ±n kÄ±sa vadeli borÃ§lara oranÄ±. 1'in altÄ±nda likidite sÄ±kÄ±ntÄ±sÄ± olabilir.</div>
          <span class="iitem-tip tip-bad">âœ• 1'in altÄ± â€” riskli</span>
          <span class="iitem-tip tip-good">âœ“ 1.5â€“3 arasÄ± saÄŸlÄ±klÄ±</span>
        </div>
      </div>
      <div class="preset-info-wrap">
        <div class="preset-info-title">âš¡ HazÄ±r Filtre Presetleri</div>
        <div class="preset-info-grid">
          <div class="picard"><div class="picard-name">DEÄER</div><div class="picard-desc">Ucuz kalmÄ±ÅŸ, dÃ¼ÅŸÃ¼k F/K ve PD/DD ile iÅŸlem gÃ¶ren hisseler.</div><div class="picard-rules"><span class="picard-rule">F/K &lt;15</span><span class="picard-rule">PD/DD &lt;2</span><span class="picard-rule">TemettÃ¼ &gt;2%</span></div></div>
          <div class="picard"><div class="picard-name">BÃœYÃœME</div><div class="picard-desc">HÄ±zlÄ± bÃ¼yÃ¼yen, gÃ¼Ã§lÃ¼ kÃ¢r ve gelir artÄ±ÅŸÄ± gÃ¶steren hisseler.</div><div class="picard-rules"><span class="picard-rule">K.BÃ¼y &gt;20%</span><span class="picard-rule">Gelir &gt;15%</span><span class="picard-rule">ROE &gt;15%</span></div></div>
          <div class="picard"><div class="picard-name">TEMETTÃœ</div><div class="picard-desc">YÃ¼ksek temettÃ¼ Ã¶deyen, borÃ§ yÃ¼kÃ¼ makul hisseler.</div><div class="picard-rules"><span class="picard-rule">TemettÃ¼ &gt;4%</span><span class="picard-rule">B/Ã– &lt;100</span></div></div>
          <div class="picard"><div class="picard-name">KALÄ°TELÄ°</div><div class="picard-desc">YÃ¼ksek karlÄ±lÄ±k, gÃ¼Ã§lÃ¼ marj, dÃ¼ÅŸÃ¼k borÃ§ ve iyi likidite.</div><div class="picard-rules"><span class="picard-rule">ROE &gt;20%</span><span class="picard-rule">Marj &gt;10%</span><span class="picard-rule">B/Ã– &lt;80</span><span class="picard-rule">Cari &gt;1.5</span></div></div>
          <div class="picard"><div class="picard-name">DÃœÅÃœK BORÃ‡</div><div class="picard-desc">Az borÃ§la Ã§alÄ±ÅŸan ve gÃ¼Ã§lÃ¼ likiditeye sahip hisseler.</div><div class="picard-rules"><span class="picard-rule">B/Ã– &lt;30</span><span class="picard-rule">Cari &gt;2</span></div></div>
          <div class="picard"><div class="picard-name">MOMENTUM</div><div class="picard-desc">Her iki bÃ¼yÃ¼me metriÄŸinde gÃ¼Ã§lÃ¼ ivme yakalayan hisseler.</div><div class="picard-rules"><span class="picard-rule">Gelir &gt;20%</span><span class="picard-rule">K.BÃ¼y &gt;20%</span></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ SUPPORT MODAL â”€â”€â”€ -->
<div class="smodal-overlay" id="supportModal">
  <div class="smodal" onclick="event.stopPropagation()">
    <div class="smodal-head"><div></div><button class="smodal-close" onclick="closeSupport()">âœ•</button></div>
    <div class="smodal-hero">
      <span class="smodal-emoji">â˜•</span>
      <div class="smodal-title">BÄ°ZÄ° DESTEKLEYÄ°N</div>
      <div class="smodal-desc">Bu araÃ§ <strong>tamamen Ã¼cretsiz</strong> olarak sunulmaktadÄ±r â€” reklam yok, kayÄ±t yok, sÄ±nÄ±r yok.<br><br>BIST TarayÄ±cÄ±'yÄ± geliÅŸtirmek ve gÃ¼ncel tutmak iÃ§in <strong>geliÅŸtirme ve altyapÄ± maliyetleri</strong> bulunmaktadÄ±r. EÄŸer bu araÃ§ iÅŸinize yaradÄ±ysa, bir kahve Ä±smarlayarak destek olabilirsiniz. ğŸ™</div>
    </div>
    <div class="smodal-options">
      <div class="smodal-options-title">Destek YÃ¶ntemleri</div>
      <div class="soption">
        <div class="soption-head"><span class="soption-icon">â˜•</span><div><div class="soption-label">Buy Me a Coffee</div><div class="soption-sublabel">Kredi kartÄ± veya PayPal ile kolayca destek ol</div></div></div>
        <a class="bmc-link" href="https://buymeacoffee.com/KULLANICI_ADINIZ" target="_blank" rel="noopener"><span>â˜•</span> buymeacoffee.com/KULLANICI_ADINIZ</a>
      </div>
      <div class="soption">
        <div class="soption-head"><span class="soption-icon">â‚¿</span><div><div class="soption-label">Kripto Para ile Destek</div><div class="soption-sublabel">Adrese tÄ±klayarak kopyalayabilirsiniz</div></div></div>
        <div class="wallet-row"><span class="wallet-coin">BTC</span><div class="wallet-addr">bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh</div><button class="copy-btn" onclick="copyWallet(this,'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh')">KOPYALA</button></div>
        <div class="wallet-row"><span class="wallet-coin">ETH</span><div class="wallet-addr">0x71C7656EC7ab88b098defB751B7401B5f6d8976F</div><button class="copy-btn" onclick="copyWallet(this,'0x71C7656EC7ab88b098defB751B7401B5f6d8976F')">KOPYALA</button></div>
        <div class="wallet-row"><span class="wallet-coin">USDT</span><div class="wallet-addr">TN3W4H6rK2ce4vX9YnFQHwKx7TS2V5sL2h</div><button class="copy-btn" onclick="copyWallet(this,'TN3W4H6rK2ce4vX9YnFQHwKx7TS2V5sL2h')">KOPYALA</button></div>
        <div class="wallet-row"><span class="wallet-coin">BNB</span><div class="wallet-addr">0x71C7656EC7ab88b098defB751B7401B5f6d8976F</div><button class="copy-btn" onclick="copyWallet(this,'0x71C7656EC7ab88b098defB751B7401B5f6d8976F')">KOPYALA</button></div>
      </div>
    </div>
    <div class="smodal-thanks">DesteÄŸiniz iÃ§in ÅŸimdiden <strong>Ã§ok teÅŸekkÃ¼r ederiz</strong> ğŸ™</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BIST SYMBOLS â€” Full list (150+ hisse)
// Finnhub uses SYMBOL.IS format for BIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BIST_SYMBOLS = [
  // BIST-100 Ana hisseler
  {symbol:'THYAO',name:'TÃ¼rk Hava YollarÄ±'},
  {symbol:'GARAN',name:'Garanti BBVA'},
  {symbol:'AKBNK',name:'Akbank'},
  {symbol:'EREGL',name:'EreÄŸli Demir Ã‡elik'},
  {symbol:'KCHOL',name:'KoÃ§ Holding'},
  {symbol:'SAHOL',name:'SabancÄ± Holding'},
  {symbol:'SISE',name:'ÅiÅŸe ve Cam'},
  {symbol:'ASELS',name:'Aselsan'},
  {symbol:'FROTO',name:'Ford Otosan'},
  {symbol:'TOASO',name:'TofaÅŸ Otomobil'},
  {symbol:'YKBNK',name:'YapÄ± Kredi BankasÄ±'},
  {symbol:'PGSUS',name:'Pegasus'},
  {symbol:'BIMAS',name:'BÄ°M MaÄŸazalar'},
  {symbol:'TUPRS',name:'TÃ¼praÅŸ'},
  {symbol:'PETKM',name:'Petkim'},
  {symbol:'ARCLK',name:'ArÃ§elik'},
  {symbol:'KRDMD',name:'Kardemir'},
  {symbol:'TTKOM',name:'TÃ¼rk Telekom'},
  {symbol:'TCELL',name:'Turkcell'},
  {symbol:'ULKER',name:'Ãœlker BiskÃ¼vi'},
  {symbol:'HEKTS',name:'HektaÅŸ'},
  {symbol:'GUBRF',name:'GÃ¼bre FabrikalarÄ±'},
  {symbol:'VESTL',name:'Vestel'},
  {symbol:'MGROS',name:'Migros'},
  {symbol:'DOHOL',name:'DoÄŸan Holding'},
  {symbol:'KOZAL',name:'Koza AltÄ±n'},
  {symbol:'ISCTR',name:'Ä°ÅŸ BankasÄ±'},
  {symbol:'VAKBN',name:'VakÄ±fbank'},
  {symbol:'HALKB',name:'Halkbank'},
  {symbol:'ALARK',name:'Alarko Holding'},
  {symbol:'CCOLA',name:'Coca-Cola Ä°Ã§ecek'},
  {symbol:'LOGO',name:'Logo YazÄ±lÄ±m'},
  {symbol:'NETAS',name:'NetaÅŸ TelekomÃ¼nikasyon'},
  {symbol:'AEFES',name:'Anadolu Efes'},
  {symbol:'BRISA',name:'Brisa Bridgestone'},
  {symbol:'EKGYO',name:'Emlak Konut GYO'},
  {symbol:'ISGYO',name:'Ä°ÅŸ GYO'},
  {symbol:'SNGYO',name:'SinpaÅŸ GYO'},
  {symbol:'ENKAI',name:'Enka Ä°nÅŸaat'},
  {symbol:'OZRDN',name:'Ã–zerden'},
  {symbol:'AKSEN',name:'Aksen Enerji'},
  {symbol:'KOZAA',name:'Koza Anadolu Metal'},
  {symbol:'ANACM',name:'Anadolu Cam'},
  {symbol:'TRKCM',name:'Trakya Cam'},
  {symbol:'SOKM',name:'Åok Marketler'},
  {symbol:'ODAS',name:'OdaÅŸ Elektrik'},
  {symbol:'TAVHL',name:'TAV HavalimanlarÄ±'},
  {symbol:'SASA',name:'Sasa Polyester'},
  {symbol:'CELHA',name:'Ã‡elik Halat'},
  {symbol:'KARSN',name:'Karsan Otomotiv'},
  {symbol:'DOAS',name:'DoÄŸuÅŸ Otomotiv'},
  {symbol:'GESAN',name:'Gedik Seramik'},
  {symbol:'TKFEN',name:'Tekfen Holding'},
  {symbol:'ENJSA',name:'Enerjisa Enerji'},
  {symbol:'AKFGY',name:'AkiÅŸ GYO'},
  {symbol:'MAVI',name:'Mavi Giyim'},
  {symbol:'BERA',name:'Bera Holding'},
  {symbol:'CANTE',name:'Ã‡an Tekstil'},
  {symbol:'ERBOS',name:'Erbosan'},
  {symbol:'EGEEN',name:'Ege EndÃ¼stri'},
  {symbol:'INDES',name:'Ä°ndeks Bilgisayar'},
  {symbol:'TRGYO',name:'Torunlar GYO'},
  {symbol:'ISDMR',name:'Ä°skenderun Demir Ã‡elik'},
  {symbol:'OTKAR',name:'Otokar'},
  {symbol:'VESBE',name:'Vestel Beyaz EÅŸya'},
  {symbol:'KONTR',name:'Kontrolmatik'},
  {symbol:'KOCMT',name:'KoÃ§ Ã‡imento Deva'},
  {symbol:'POLHO',name:'Polisan Holding'},
  {symbol:'ALGYO',name:'Alarko GYO'},
  {symbol:'DEVA',name:'Deva Holding'},
  {symbol:'SKBNK',name:'Åekerbank'},
  {symbol:'GLYHO',name:'Global YatÄ±rÄ±m Holding'},
  {symbol:'HLGYO',name:'Halk GYO'},
  {symbol:'ZRGYO',name:'Ziraat GYO'},
  {symbol:'ISFIN',name:'Ä°ÅŸ Finansal Kiralama'},
  {symbol:'AGHOL',name:'AG Anadolu Grubu'},
  {symbol:'ARSAN',name:'Arsan Tekstil'},
  {symbol:'CWENE',name:'CW Enerji'},
  {symbol:'ATAKP',name:'Ata Kap GiriÅŸim'},
  {symbol:'SELEC',name:'SelÃ§uk Ecza'},
  {symbol:'KLRHO',name:'KerevitaÅŸ GÄ±da'},
  {symbol:'LMKDC',name:'LimaÅŸ'},
  {symbol:'PAGYO',name:'Pera GYO'},
  {symbol:'YGYO',name:'Yeni Gimat GYO'},
  {symbol:'SMART',name:'Smart GÃ¼neÅŸ'},
  {symbol:'KARTN',name:'Kartonsan'},
  {symbol:'ADEL',name:'Adel Kalemcilik'},
  {symbol:'AFYON',name:'Afyon Ã‡imento'},
  {symbol:'AKGRT',name:'Aksigorta'},
  {symbol:'AKMGY',name:'Akmerkez GYO'},
  {symbol:'AKCNS',name:'AkÃ§ansa'},
  {symbol:'ALCTL',name:'Alcatel-Lucent'},
  {symbol:'ANHYT',name:'Anadolu Hayat'},
  {symbol:'ANSGR',name:'Anadolu Sigorta'},
  {symbol:'ARMDA',name:'Armada'},
  {symbol:'ASUZU',name:'Anadolu Isuzu'},
  {symbol:'BAGFS',name:'BagfaÅŸ GÃ¼bre'},
  {symbol:'BAKAB',name:'Bak Ambalaj'},
  {symbol:'BANVT',name:'Banvit'},
  {symbol:'BARMA',name:'Barmak Maden'},
  {symbol:'BEYAZ',name:'Beyaz Filo'},
  {symbol:'BFREN',name:'Bosch Fren'},
  {symbol:'BIMAS',name:'BÄ°M MaÄŸazalar'},
  {symbol:'BIZIM',name:'Bizim Toptan'},
  {symbol:'BMEKS',name:'Bimeks Bilgi Ä°ÅŸlem'},
  {symbol:'BNTAS',name:'BantaÅŸ'},
  {symbol:'BOSSA',name:'Bossa'},
  {symbol:'BUCIM',name:'Bursa Ã‡imento'},
  {symbol:'BURCE',name:'BurÃ§elik'},
  {symbol:'BURVA',name:'Bursa Ã‡imento FabrikalarÄ±'},
  {symbol:'CIMBETON',name:'Cimbeton'},
  {symbol:'CIMSA',name:'Ã‡imsa'},
  {symbol:'CLEBI',name:'Ã‡elebi Hava Servisi'},
  {symbol:'CPHO',name:'Ã‡aÄŸrÄ± Holding'},
  {symbol:'DAGI',name:'Dagi Giyim'},
  {symbol:'DENGE',name:'Denge YatÄ±rÄ±m Holding'},
  {symbol:'DGKLB',name:'DoÄŸanlar Mobilya'},
  {symbol:'DITAS',name:'DitaÅŸ DoÄŸan'},
  {symbol:'DYOBY',name:'DYO Boya'},
  {symbol:'ECILC',name:'EczacÄ±baÅŸÄ± Ä°laÃ§'},
  {symbol:'EGPRO',name:'EG Pro Enerji'},
  {symbol:'EMKEL',name:'Emkel'},
  {symbol:'FENER',name:'FenerbahÃ§e'},
  {symbol:'FLAP',name:'Flap Kongre'},
  {symbol:'GSDDE',name:'GSD Denizcilik'},
  {symbol:'GSDHO',name:'GSD Holding'},
  {symbol:'GSRAY',name:'Galatasaray'},
  {symbol:'HZNDR',name:'Haznedar'},
  {symbol:'IDEAS',name:'IDEAS'},
  {symbol:'IKTL',name:'Ä°ktisat YatÄ±rÄ±m'},
  {symbol:'IPEKE',name:'Ä°pek Enerji'},
  {symbol:'ISATR',name:'Ä°ÅŸ PortfÃ¶y'},
  {symbol:'JANTS',name:'Jantsa'},
  {symbol:'KATMR',name:'Katmerciler'},
  {symbol:'KERVT',name:'KerevitaÅŸ'},
  {symbol:'KLNMA',name:'KalÄ±nma Bank'},
  {symbol:'KNFRT',name:'Konfrut GÄ±da'},
  {symbol:'KONKA',name:'Konka'},
  {symbol:'KONYA',name:'Konya Ã‡imento'},
  {symbol:'KRPLAS',name:'KÄ±r Plastik'},
  {symbol:'KUYAS',name:'KuyaÅŸ'},
  {symbol:'LIDER',name:'Lider Faktoring'},
  {symbol:'LINK',name:'Link Bilgisayar'},
  {symbol:'MAALT',name:'Mardin Ã‡imento'},
  {symbol:'MNDRS',name:'Menderes Tekstil'},
  {symbol:'MOBTL',name:'Mobiltel'},
  {symbol:'NBORU',name:'NetBoru'},
  {symbol:'NTHOL',name:'Net Holding'},
  {symbol:'ORFIN',name:'Ã–ner Finans'},
  {symbol:'ORGE',name:'Orge Enerji'},
  {symbol:'PAPIL',name:'Papilon'},
  {symbol:'PCILT',name:'Pcilet'},
  {symbol:'PENGD',name:'Penguen GÄ±da'},
  {symbol:'PKART',name:'Plastik Kart'},
  {symbol:'PRKAB',name:'TÃ¼rk Prysmian Kablo'},
  {symbol:'PRKME',name:'Park Elektrik'},
  {symbol:'PSILO',name:'Ege Seramik'},
  {symbol:'RHEAG',name:'Rheag'},
  {symbol:'RTALB',name:'RT Alba'},
  {symbol:'RUBNS',name:'Rubenis'},
  {symbol:'SARKY',name:'Sarkuysan'},
  {symbol:'SILVR',name:'Silver Dilber'},
  {symbol:'SMART',name:'Smart GES'},
  {symbol:'SNKRN',name:'Åenkron Teknoloji'},
  {symbol:'SRVGY',name:'Servet GYO'},
  {symbol:'TAHEM',name:'TAH Enerji'},
  {symbol:'TATGD',name:'Tat GÄ±da'},
  {symbol:'TDGYO',name:'Trend GYO'},
  {symbol:'TEKTU',name:'Tek-Art'},
  {symbol:'TEZOL',name:'Tezol Tekstil'},
  {symbol:'TKNSA',name:'Teknosa'},
  {symbol:'TMPOL',name:'Tem Polimer'},
  {symbol:'TRGYO',name:'Torunlar GYO'},
  {symbol:'TRILC',name:'Trilyum'},
  {symbol:'TURSG',name:'TÃ¼rkiye Sigorta'},
  {symbol:'TUCLK',name:'TuÃ§ka Uzay'},
  {symbol:'USAK',name:'UÅŸak Seramik'},
  {symbol:'VAKFN',name:'VakÄ±f Finansal'},
  {symbol:'VKGYO',name:'VakÄ±f GYO'},
  {symbol:'YATAS',name:'YataÅŸ'},
  {symbol:'YBTAS',name:'YibitaÅŸ'},
  {symbol:'YESIL',name:'YeÅŸil YatÄ±rÄ±m'},
  {symbol:'YUNSA',name:'YÃ¼nsa'},
  {symbol:'ZOREN',name:'Zorlu Enerji'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXY_URL = '/api/scan';
let allData = [];
let filtered = [];
let searchQ = '';
let selSym = null;
let sortSt = {field:'marketCapitalization', dir:'desc'};
let scanAborted = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
  showApp();
}

function showApp(){
  document.getElementById('empty-sub').textContent = `500+ hisse taranacak Â· TradingView`;
}

// Sleep helper
const sleep = ms => new Promise(r => setTimeout(r, ms));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADINGVIEW SCANNER â€” tek istekte tÃ¼m BIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runScan(){
  const btn = document.getElementById('scanbtn');
  btn.disabled = true;
  scanAborted = false;
  document.getElementById('stopbtn').style.display = 'none';
  allData = [];
  filtered = [];
  selSym = null;
  closeDetail();
  showState('loading');
  document.getElementById('toolbar').style.display = 'none';
  document.getElementById('prog').style.width = '30%';
  document.getElementById('loadtxt').textContent = 'TradingView\'den veri Ã§ekiliyor...';
  document.getElementById('loadsub').textContent = 'Tek istekte tÃ¼m BIST hisseleri alÄ±nÄ±yor...';

  const payload = {
    columns: [
      'name',
      'close',
      'change',
      'volume',
      'market_cap_basic',
      'price_earnings_ttm',
      'price_book_ratio',
      'price_sales_current',
      'return_on_equity',
      'return_on_assets',
      'net_income_to_total_revenue_ttm',
      'gross_profit_to_revenue_ttm',
      'total_revenue_change_ttm_yoy',
      'earnings_per_share_change_ttm_yoy',
      'dividends_yield_current',
      'total_debt_to_equity',
      'current_ratio',
      'sector',
      'High.1M',
      'Low.1M'
    ],
    range: [0, 500],
    sort: { sortBy: 'market_cap_basic', sortOrder: 'desc' }
  };

  try {
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    document.getElementById('prog').style.width = '70%';

    const text = await res.text();
    if(!res.ok) throw new Error(`Proxy hatasÄ±: HTTP ${res.status} â€” ${text.slice(0,200)}`);

    let json;
    try { json = JSON.parse(text); } catch(e) { throw new Error('Parse hatasÄ±: ' + text.slice(0,200)); }

    // EÄŸer body string olarak geldiyse (eski proxy formatÄ±) iÃ§ini parse et
    if(json.body && typeof json.body === 'string') {
      try { json = JSON.parse(json.body); } catch(e) { throw new Error('Body parse hatasÄ±: ' + json.body.slice(0,200)); }
    }

    if(json.error) throw new Error('API: ' + json.error);
    if(!json.data || json.data.length === 0) throw new Error('Veri yok â€” keys:' + Object.keys(json).join(','));

    document.getElementById('prog').style.width = '100%';

    // Parse TradingView response
    const results = [];
    for(const row of json.data) {
      const d = row.d;
      const [
        name, close, change, volume, mcap,
        pe, pb, ps, roe, roa,
        netMargin, grossMargin,
        divYield, deRatio, currentRatio, sector,
        high1m, low1m
      ] = d;

      // TradingView sembol formatÄ±: "BIST:THYAO" â†’ "THYAO"
      const symbol = (row.s || '').replace('BIST:', '');

      if(!close || close === 0) continue;

      results.push({
        symbol,
        name: name || symbol,
        currentPrice: close,
        previousClose: close / (1 + (change||0)/100),
        changePercent: change || null,
        volume: volume || null,
        marketCapitalization: mcap ? mcap / 1e6 : null, // TradingView â†’ milyon USD
        peNormalizedAnnual: pe || null,
        pbAnnual: pb || null,
        psTTM: ps || null,
        roeTTM: roe || null,        // TradingView zaten % olarak gÃ¶nderiyor
        roaTTM: roa || null,
        netProfitMarginTTM: netMargin || null,
        grossMarginTTM: grossMargin || null,
        revenueGrowthTTMYoy: null,
        epsGrowthTTMYoy: null,
        dividendYieldIndicatedAnnual: divYield || null,
        'totalDebt/totalEquityAnnual': deRatio || null,
        currentRatioAnnual: currentRatio || null,
        sector: sector || null,
        '52WeekHigh': high1m || null,
        '52WeekLow': low1m || null,
      });
    }

    if(results.length === 0) throw new Error('HiÃ§ hisse verisi iÅŸlenemedi');

    allData = results;
    document.getElementById('scantime').textContent = `â†» ${new Date().toLocaleTimeString('tr-TR')} Â· ${results.length} hisse`;
    applyAndRender();

  } catch(err) {
    showState('errstate');
    document.getElementById('errmsg').textContent = err.message || 'Bilinmeyen hata';
  } finally {
    btn.disabled = false;
    document.getElementById('stopbtn').style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRESETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRESETS = {
  value:    { desc: 'Ucuz kalmÄ±ÅŸ hisseler â€” dÃ¼ÅŸÃ¼k F/K (<15), dÃ¼ÅŸÃ¼k PD/DD (<2), temettÃ¼ Ã¶deyen (>%2)', filters: {pe_max:15, pb_max:2, div_min:2} },
  growth:   { desc: 'HÄ±zlÄ± bÃ¼yÃ¼yen ÅŸirketler â€” gÃ¼Ã§lÃ¼ kazanÃ§ ve gelir artÄ±ÅŸÄ±, yÃ¼ksek ROE', filters: {earng_min:20, revg_min:15, roe_min:15} },
  dividend: { desc: 'YÃ¼ksek temettÃ¼ Ã¶deyen, borÃ§ yÃ¼kÃ¼ makul hisseler (>%4 temettÃ¼)', filters: {div_min:4, de_max:100} },
  quality:  { desc: 'YÃ¼ksek karlÄ±lÄ±k, gÃ¼Ã§lÃ¼ marj, dÃ¼ÅŸÃ¼k borÃ§ ve iyi likidite â€” kaliteli ÅŸirket', filters: {roe_min:20, margin_min:10, de_max:80, cr_min:1.5} },
  lowdebt:  { desc: 'Az borÃ§la Ã§alÄ±ÅŸan, nakit akÄ±ÅŸÄ± gÃ¼Ã§lÃ¼, bilanÃ§o saÄŸlÄ±klÄ± hisseler', filters: {de_max:30, cr_min:2} },
  momentum: { desc: 'Hem gelir hem kazanÃ§ bÃ¼yÃ¼mesinde gÃ¼Ã§lÃ¼ ivme yakalayan hisseler', filters: {revg_min:20, earng_min:20} }
};

// Guru stratejileri
const GURUS = {
  buffett: {
    label: 'Warren Buffett',
    desc: 'GÃ¼Ã§lÃ¼ marka, yÃ¼ksek ROE, dÃ¼ÅŸÃ¼k borÃ§, makul fiyat',
    filters: {pe_min:5, pe_max:20, pb_max:3, roe_min:15, de_max:80, cr_min:1.2, margin_min:10}
  },
  graham: {
    label: 'Benjamin Graham',
    desc: 'Derin deÄŸer: Ã§ok dÃ¼ÅŸÃ¼k F/K, PD/DD<1, gÃ¼Ã§lÃ¼ bilanÃ§o',
    filters: {pe_max:10, pb_max:1.2, de_max:50, cr_min:2, div_min:1}
  },
  lynch: {
    label: 'Peter Lynch',
    desc: 'BÃ¼yÃ¼me+DeÄŸer: iyi ROE, makul F/K, saÄŸlÄ±klÄ± bÃ¼yÃ¼me',
    filters: {pe_min:5, pe_max:25, roe_min:12, margin_min:8, de_max:100, cr_min:1}
  },
  ark: {
    label: 'Cathie Wood / ARK',
    desc: 'YÃ¼ksek bÃ¼yÃ¼me, gÃ¼Ã§lÃ¼ momentum, teknoloji aÄŸÄ±rlÄ±klÄ±',
    filters: {roe_min:10, earng_min:15}
  },
  minervini: {
    label: 'Mark Minervini â€” SEPA',
    desc: 'SEPA: GÃ¼Ã§lÃ¼ kazanÃ§ bÃ¼yÃ¼mesi (>%25), yÃ¼ksek ROE (>%17), saÄŸlÄ±klÄ± marj (>%10), dÃ¼ÅŸÃ¼k borÃ§. 52 hafta yÃ¼kseÄŸine yakÄ±n, gÃ¼Ã§lÃ¼ momentum arayan bÃ¼yÃ¼me traderÄ± stratejisi.',
    filters: {earng_min:25, roe_min:17, margin_min:10, de_max:100, cr_min:1}
  }
};

document.getElementById('goat-chips').addEventListener('click', e => {
  const chip = e.target.closest('.goat-chip');
  if(!chip) return;
  const name = chip.dataset.goat;
  const goat = GURUS[name];
  if(!goat) return;

  clearFilters(false);
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  chip.classList.add('on');

  for(const [k,v] of Object.entries(goat.filters)){
    const el = document.getElementById(k);
    if(el) el.value = v;
  }

  const infoEl = document.getElementById('goat-info');
  if(infoEl){
    infoEl.innerHTML = `<strong>${goat.label}:</strong> ${goat.desc}`;
    infoEl.style.display = 'block';
  }

  if(allData.length) applyAndRender();
});

document.getElementById('presets').addEventListener('click', e => {
  const chip = e.target.closest('.chip');
  if(!chip) return;
  const name = chip.dataset.preset;
  const preset = PRESETS[name];
  if(!preset) return;
  clearFilters(false);
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  chip.classList.add('on');
  for(const [k,v] of Object.entries(preset.filters)){
    const el = document.getElementById(k);
    if(el) el.value = v;
  }
  const infoEl = document.getElementById('preset-info');
  if(infoEl){ infoEl.innerHTML = preset.desc; infoEl.style.display = 'block'; }
  if(allData.length) applyAndRender();
});

function clearFilters(resetChips=true){
  document.querySelectorAll('.finps input').forEach(i=>i.value='');
  if(resetChips) { document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on')); ['goat-info','preset-info'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';}); }
  if(allData.length) applyAndRender();
}

function liveFilter(){
  if(allData.length) applyAndRender();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER + RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getN(id){ const v=parseFloat(document.getElementById(id)?.value); return isNaN(v)?null:v; }

function applyAndRender(){
  // Filter rules: [dataField, minInputId, maxInputId, multiplier]
  const rules = [
    ['peNormalizedAnnual',             'pe_min',     'pe_max',     1],
    ['pbAnnual',                       'pb_min',     'pb_max',     1],
    ['psTTM',                          'ps_min',     'ps_max',     1],
    ['roeTTM',                         'roe_min',    'roe_max',    1],   // already %
    ['roaTTM',                         'roa_min',    'roa_max',    1],
    ['netProfitMarginTTM',             'margin_min', 'margin_max', 1],
    ['revenueGrowthTTMYoy',            'revg_min',   'revg_max',  1],
    ['epsGrowthTTMYoy',                'earng_min',  'earng_max', 1],
    ['dividendYieldIndicatedAnnual',   'div_min',    'div_max',   1],
    ['totalDebt/totalEquityAnnual',    'de_min',     'de_max',    1],
    ['currentRatioAnnual',             'cr_min',     'cr_max',    1],
    ['marketCapitalization',           'mc_min',     'mc_max',    1],
  ];

  filtered = allData.filter(s => {
    if(searchQ){
      const q = searchQ.toUpperCase();
      if(!s.symbol.includes(q) && !s.name.toUpperCase().includes(q)) return false;
    }
    for(const [field, minId, maxId, mult] of rules){
      const mn=getN(minId), mx=getN(maxId);
      if(mn===null && mx===null) continue;
      const raw = s[field];
      if(raw===null||raw===undefined){ if(mn!==null||mx!==null) return false; continue; }
      const val = raw * mult;
      if(mn!==null && val<mn) return false;
      if(mx!==null && val>mx) return false;
    }
    return true;
  });

  document.getElementById('toolbar').style.display = 'flex';
  document.getElementById('resn').textContent = filtered.length;
  document.getElementById('scann').textContent = allData.length;
  showState('twrap');
  renderTable();
}

function onSearch(){
  searchQ = document.getElementById('searchbox').value.trim();
  if(allData.length) applyAndRender();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function colSort(f){
  if(sortSt.field===f) sortSt.dir = sortSt.dir==='desc'?'asc':'desc';
  else { sortSt.field=f; sortSt.dir='desc'; }
  renderTable();
}
function onSortChange(){
  sortSt.field = document.getElementById('sortf').value;
  sortSt.dir   = document.getElementById('sortd').value;
  renderTable();
}
function sorted(arr){
  return [...arr].sort((a,b)=>{
    const av = a[sortSt.field] ?? (sortSt.dir==='desc'?-Infinity:Infinity);
    const bv = b[sortSt.field] ?? (sortSt.dir==='desc'?-Infinity:Infinity);
    return sortSt.dir==='desc' ? bv-av : av-bv;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const nil = '<span class="nil">â€”</span>';

function fv(v, dec=2, pct=false){
  if(v===null||v===undefined||isNaN(v)) return nil;
  const cls = pct ? (v>=0?'up':'dn') : '';
  const sign = pct && v>0 ? '+' : '';
  return `<span class="${cls}">${sign}${v.toFixed(dec)}${pct?'%':''}</span>`;
}
function fmc(v){
  if(!v) return nil;
  // Finnhub returns in millions USD, convert display
  if(v>=1000) return `${(v/1000).toFixed(1)}B`;
  return `${v.toFixed(0)}M`;
}

function renderTable(){
  const data = sorted(filtered);
  // Update sorted column header
  document.querySelectorAll('thead th').forEach(th=>{
    const oc = th.getAttribute('onclick')||'';
    const match = oc.match(/colSort\('([^']+)'\)/);
    if(match){
      th.classList.toggle('sorted', match[1]===sortSt.field);
      th.classList.toggle('asc', match[1]===sortSt.field && sortSt.dir==='asc');
    }
  });

  document.getElementById('tbody').innerHTML = data.map(s=>{
    const chgPct = s.changePercent;
    const chgClass = chgPct===null ? '' : (chgPct>=0?'up':'dn');
    const chgTxt = chgPct===null ? 'â€”' : `${chgPct>=0?'+':''}${chgPct.toFixed(2)}%`;
    return `<tr onclick="showDetail('${s.symbol}')" class="${selSym===s.symbol?'selrow':''}">
      <td><span class="sym">${s.symbol}</span></td>
      <td class="nmc" title="${s.name}">${s.name}</td>
      <td>${s.currentPrice!=null?s.currentPrice.toFixed(2)+' â‚º':nil}</td>
      <td><span class="${chgClass}">${chgTxt}</span></td>
      <td>${fmc(s.marketCapitalization)}</td>
      <td>${fv(s.peNormalizedAnnual,1)}</td>
      <td>${fv(s.pbAnnual,2)}</td>
      <td>${fv(s.psTTM,2)}</td>
      <td>${fv(s.roeTTM,1,true)}</td>
      <td>${fv(s.roaTTM,1,true)}</td>
      <td>${fv(s.netProfitMarginTTM,1,true)}</td>
      <td>${fv(s.revenueGrowthTTMYoy,1,true)}</td>
      <td>${fv(s.epsGrowthTTMYoy,1,true)}</td>
      <td>${s.dividendYieldIndicatedAnnual!=null?`<span class="up">${s.dividendYieldIndicatedAnnual.toFixed(2)}%</span>`:nil}</td>
      <td>${fv(s['totalDebt/totalEquityAnnual'],1)}</td>
      <td>${fv(s.currentRatioAnnual,2)}</td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(sym){
  const s = allData.find(x=>x.symbol===sym);
  if(!s) return;
  selSym = sym;
  renderTable();

  document.getElementById('dsym').textContent = s.symbol;
  document.getElementById('dname').textContent = s.name;
  document.getElementById('dprice').textContent = s.currentPrice!=null?`${s.currentPrice.toFixed(2)} â‚º`:'â€”';
  
  if(s.changePercent!=null){
    const chg = s.currentPrice && s.previousClose ? s.currentPrice - s.previousClose : null;
    const cls = s.changePercent>=0?'up':'dn';
    const sign = s.changePercent>=0?'+':'';
    document.getElementById('dchg').innerHTML = `<span class="${cls}">${chg?sign+chg.toFixed(2)+' â‚º Â· ':''} ${sign}${s.changePercent.toFixed(2)}%</span>`;
  } else document.getElementById('dchg').innerHTML = '';
  
  document.getElementById('dfresh').textContent = `â†» Finnhub Â· ${new Date().toLocaleTimeString('tr-TR')}`;
  document.getElementById('dsec').textContent = s.symbol + '.IS';

  const G = [
    {t:'DeÄŸerleme', rows:[
      ['F/K <tag>TTM</tag>', s.peNormalizedAnnual, v=>v.toFixed(1)],
      ['PD/DD <tag>FQ</tag>', s.pbAnnual, v=>v.toFixed(2)],
      ['F/S <tag>TTM</tag>', s.psTTM, v=>v.toFixed(2)],
      ['Piyasa DeÄŸeri', s.marketCapitalization, v=>fmc(v)],
      ['SektÃ¶r', s.sector, v=>v],
      ['1A YÃ¼ksek', s['52WeekHigh'], v=>`${v.toFixed(2)} â‚º`],
      ['1A DÃ¼ÅŸÃ¼k', s['52WeekLow'], v=>`${v.toFixed(2)} â‚º`],
    ]},
    {t:'KarlÄ±lÄ±k', rows:[
      ['ROE <tag>FQ</tag>', s.roeTTM, v=>`<span class="${v>=0?'up':'dn'}">${v.toFixed(1)}%</span>`],
      ['ROA <tag>FQ</tag>', s.roaTTM, v=>`<span class="${v>=0?'up':'dn'}">${v.toFixed(1)}%</span>`],
      ['Net Kar MarjÄ± <tag>TTM</tag>', s.netProfitMarginTTM, v=>`<span class="${v>=0?'up':'dn'}">${v.toFixed(1)}%</span>`],
      ['BrÃ¼t Marj <tag>TTM</tag>', s.grossMarginTTM, v=>`<span class="${v>=0?'up':'dn'}">${v.toFixed(1)}%</span>`],
    ]},
    {t:'BÃ¼yÃ¼me', rows:[
      ['Gelir BÃ¼y. <tag>YoY</tag>', s.revenueGrowthTTMYoy, v=>`<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(1)}%</span>`],
      ['EPS BÃ¼y. <tag>YoY</tag>', s.epsGrowthTTMYoy, v=>`<span class="${v>=0?'up':'dn'}">${v>=0?'+':''}${v.toFixed(1)}%</span>`],
    ]},
    {t:'TemettÃ¼ & SaÄŸlÄ±k', rows:[
      ['TemettÃ¼ <tag>yÄ±llÄ±k</tag>', s.dividendYieldIndicatedAnnual, v=>`<span class="up">${v.toFixed(2)}%</span>`],
      ['BorÃ§/Ã–zkaynak <tag>FQ</tag>', s['totalDebt/totalEquityAnnual'], v=>v.toFixed(1)],
      ['Cari Oran <tag>FQ</tag>', s.currentRatioAnnual, v=>v.toFixed(2)],
    ]},
  ];

  document.getElementById('dbody').innerHTML = G.map(g=>`
    <div class="dsection">
      <div class="dstitle">${g.t}</div>
      ${g.rows.map(([k,v,fmt])=>{
        const d = (v===null||v===undefined) ? nil : fmt(v);
        return `<div class="drow"><span class="dkey">${k}</span><span class="dval">${d}</span></div>`;
      }).join('')}
    </div>`).join('');

  document.getElementById('detail').classList.add('open');
  updateChart(sym);
}

let lwChart = null;
let lwSeries = null;
let lwVolSeries = null;
let lwIndSeries = {};
let lwCandles = [];

// â”€â”€ Ä°ndikatÃ¶r hesaplama â”€â”€
function calcSMA(data, period) {
  return data.map((d, i) => {
    if (i < period - 1) return null;
    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b.close, 0);
    return { time: d.time, value: sum / period };
  }).filter(Boolean);
}

function calcEMA(data, period) {
  const k = 2 / (period + 1);
  let ema = data[0].close;
  return data.map((d, i) => {
    if (i === 0) { ema = d.close; return { time: d.time, value: ema }; }
    ema = d.close * k + ema * (1 - k);
    return { time: d.time, value: ema };
  });
}

function calcBB(data, period = 20, mult = 2) {
  const upper = [], lower = [], mid = [];
  data.forEach((d, i) => {
    if (i < period - 1) return;
    const slice = data.slice(i - period + 1, i + 1).map(x => x.close);
    const mean = slice.reduce((a, b) => a + b, 0) / period;
    const std = Math.sqrt(slice.reduce((a, b) => a + (b - mean) ** 2, 0) / period);
    mid.push({ time: d.time, value: mean });
    upper.push({ time: d.time, value: mean + mult * std });
    lower.push({ time: d.time, value: mean - mult * std });
  });
  return { upper, mid, lower };
}

function initChart(container) {
  if (lwChart) { lwChart.remove(); lwChart = null; lwSeries = null; lwVolSeries = null; lwIndSeries = {}; }
  lwChart = LightweightCharts.createChart(container, {
    width: container.offsetWidth || 340,
    height: 230,
    layout: { background: { color: '#0d1117' }, textColor: '#6a8fa8' },
    grid: { vertLines: { color: '#1c2d40' }, horzLines: { color: '#1c2d40' } },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor: '#1c2d40' },
    timeScale: { borderColor: '#1c2d40', timeVisible: true, secondsVisible: false },
    handleScroll: true, handleScale: true,
  });
  lwSeries = lwChart.addCandlestickSeries({
    upColor: '#0ff0b3', downColor: '#ff4d6d',
    borderUpColor: '#0ff0b3', borderDownColor: '#ff4d6d',
    wickUpColor: '#09c48a', wickDownColor: '#cc2244',
  });
}

function applyIndicators() {
  if (!lwCandles.length || !lwChart) return;

  // Temizle
  Object.values(lwIndSeries).forEach(s => { try { lwChart.removeSeries(s); } catch(e){} });
  lwIndSeries = {};
  if (lwVolSeries) { try { lwChart.removeSeries(lwVolSeries); } catch(e){} lwVolSeries = null; }

  const active = [...document.querySelectorAll('.itab.on')].map(t => t.dataset.ind);

  if (active.includes('MA20')) {
    const s = lwChart.addLineSeries({ color: '#f0c040', lineWidth: 1, priceLineVisible: false });
    s.setData(calcSMA(lwCandles, 20));
    lwIndSeries['MA20'] = s;
  }
  if (active.includes('MA50')) {
    const s = lwChart.addLineSeries({ color: '#38bdf8', lineWidth: 1, priceLineVisible: false });
    s.setData(calcSMA(lwCandles, 50));
    lwIndSeries['MA50'] = s;
  }
  if (active.includes('EMA20')) {
    const s = lwChart.addLineSeries({ color: '#a78bfa', lineWidth: 1, priceLineVisible: false });
    s.setData(calcEMA(lwCandles, 20));
    lwIndSeries['EMA20'] = s;
  }
  if (active.includes('BB')) {
    const bb = calcBB(lwCandles);
    const su = lwChart.addLineSeries({ color: 'rgba(56,189,248,.5)', lineWidth: 1, priceLineVisible: false });
    const sm = lwChart.addLineSeries({ color: 'rgba(56,189,248,.3)', lineWidth: 1, lineStyle: 1, priceLineVisible: false });
    const sl = lwChart.addLineSeries({ color: 'rgba(56,189,248,.5)', lineWidth: 1, priceLineVisible: false });
    su.setData(bb.upper); sm.setData(bb.mid); sl.setData(bb.lower);
    lwIndSeries['BB_u'] = su; lwIndSeries['BB_m'] = sm; lwIndSeries['BB_l'] = sl;
  }
  if (active.includes('VOL')) {
    lwVolSeries = lwChart.addHistogramSeries({
      color: 'rgba(15,240,179,.3)',
      priceFormat: { type: 'volume' },
      priceScaleId: 'vol',
      scaleMargins: { top: 0.8, bottom: 0 },
    });
    const volData = lwCandles.map(c => ({
      time: c.time,
      value: c.volume || 0,
      color: c.close >= c.open ? 'rgba(15,240,179,.3)' : 'rgba(255,77,109,.3)'
    }));
    lwVolSeries.setData(volData);
  }
}

function updateChart(sym) {
  if (!sym) return;
  const interval = document.querySelector('.ctab.on')?.dataset.interval || '240';
  const currency = document.querySelector('.ctab-cur.on')?.dataset.currency || 'TL';
  const container = document.getElementById('tv-chart-container');

  initChart(container);

  const url = '/api/scan?action=chart&symbol=' + sym + '&interval=' + interval + '&currency=' + currency;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.s !== 'ok' || !data.candles || !data.candles.length) return;
      lwCandles = data.candles.map(c => ({ time: c.t, open: c.o, high: c.h, low: c.l, close: c.c, volume: c.v || 0 }));
      lwSeries.setData(lwCandles);
      lwChart.timeScale().fitContent();
      lwChart.resize(container.offsetWidth || 340, 230);
      applyIndicators();
    })
    .catch(e => console.error('Chart error:', e));
}

function closeDetail(){
  document.getElementById('detail').classList.remove('open');
  selSym = null;
  // Chart'Ä± sÄ±fÄ±rla ki bir sonraki hisse doÄŸru yÃ¼klensin
  // chart temizleme updateChart'ta yapÄ±lÄ±yor
  if(allData.length) renderTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openInfo(){ document.getElementById('infoModal').classList.add('open'); }
function closeInfo(){ document.getElementById('infoModal').classList.remove('open'); }
function openSupport(){ document.getElementById('supportModal').classList.add('open'); }
function closeSupport(){ document.getElementById('supportModal').classList.remove('open'); }

document.getElementById('infoModal').addEventListener('click', function(e){ if(e.target===this) closeInfo(); });
document.getElementById('supportModal').addEventListener('click', function(e){ if(e.target===this) closeSupport(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeInfo(); closeSupport(); }});

function copyWallet(btn, addr){
  navigator.clipboard.writeText(addr).then(()=>{
    btn.textContent='âœ“ KOPYALANDI'; btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent='KOPYALA'; btn.classList.remove('copied'); }, 2000);
  }).catch(()=>{
    const ta=document.createElement('textarea');
    ta.value=addr; ta.style.cssText='position:fixed;opacity:0';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    btn.textContent='âœ“ KOPYALANDI'; btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent='KOPYALA'; btn.classList.remove('copied'); }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showState(id){
  ['empty','loading','errstate','twrap'].forEach(s=>{
    const el = document.getElementById(s);
    el.style.display = s===id ? (s==='twrap'?'block':'flex') : 'none';
  });
}

function abortScan(){
  scanAborted = true;
  document.getElementById('stopbtn').style.display = 'none';
  document.getElementById('scanbtn').disabled = false;
}

// Boot
init();

// â”€â”€ CHART TAB LISTENERS â”€â”€
document.getElementById('chart-tabs').addEventListener('click', e => {
  const itab = e.target.closest('.ctab');
  const ctab = e.target.closest('.ctab-cur');
  if(itab){
    document.querySelectorAll('#chart-tabs .ctab').forEach(t=>t.classList.remove('on'));
    itab.classList.add('on');
    if(selSym) updateChart(selSym);
  }
  if(ctab){
    document.querySelectorAll('.ctab-cur').forEach(t=>t.classList.remove('on'));
    ctab.classList.add('on');
    if(selSym) updateChart(selSym);
  }
});

document.getElementById('ind-tabs').addEventListener('click', e => {
  const itab = e.target.closest('.itab');
  if(!itab) return;
  itab.classList.toggle('on');
  applyIndicators();
});

// â”€â”€ CHART TOOLBAR â”€â”€
let activeTool = 'cursor';
let drawingLines = [];
let drawingStart = null;
let isDrawing = false;
let drawCanvas = null;
let drawCtx = null;

function initDrawCanvas() {
  const container = document.getElementById('tv-chart-container');
  if (!container) return;
  drawCanvas = document.getElementById('draw-canvas');
  if (!drawCanvas) {
    drawCanvas = document.createElement('canvas');
    drawCanvas.id = 'draw-canvas';
    drawCanvas.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;';
    container.style.position = 'relative';
    container.appendChild(drawCanvas);
  }
  drawCanvas.width = container.offsetWidth;
  drawCanvas.height = container.offsetHeight;
  drawCtx = drawCanvas.getContext('2d');
}

function redrawAll() {
  if (!drawCtx || !drawCanvas) return;
  drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
  drawingLines.forEach(l => drawShape(l, false));
}

function drawShape(shape, preview) {
  if (!drawCtx) return;
  drawCtx.strokeStyle = preview ? 'rgba(15,240,179,.6)' : 'rgba(15,240,179,.9)';
  drawCtx.lineWidth = 1.5;
  drawCtx.setLineDash([]);
  drawCtx.beginPath();

  if (shape.type === 'line') {
    drawCtx.moveTo(shape.x1, shape.y1);
    drawCtx.lineTo(shape.x2, shape.y2);
    drawCtx.stroke();
    // Arrow head
    const angle = Math.atan2(shape.y2 - shape.y1, shape.x2 - shape.x1);
    drawCtx.beginPath();
    drawCtx.moveTo(shape.x2, shape.y2);
    drawCtx.lineTo(shape.x2 - 8*Math.cos(angle-0.4), shape.y2 - 8*Math.sin(angle-0.4));
    drawCtx.moveTo(shape.x2, shape.y2);
    drawCtx.lineTo(shape.x2 - 8*Math.cos(angle+0.4), shape.y2 - 8*Math.sin(angle+0.4));
    drawCtx.stroke();
  } else if (shape.type === 'hline') {
    drawCtx.setLineDash([4, 3]);
    drawCtx.moveTo(0, shape.y1);
    drawCtx.lineTo(drawCanvas.width, shape.y1);
    drawCtx.stroke();
    drawCtx.setLineDash([]);
    // Price label
    if (shape.label) {
      drawCtx.fillStyle = 'rgba(15,240,179,.9)';
      drawCtx.font = '9px JetBrains Mono, monospace';
      drawCtx.fillText(shape.label, drawCanvas.width - 60, shape.y1 - 3);
    }
  } else if (shape.type === 'rect') {
    drawCtx.strokeStyle = preview ? 'rgba(240,192,64,.5)' : 'rgba(240,192,64,.7)';
    drawCtx.fillStyle = preview ? 'rgba(240,192,64,.04)' : 'rgba(240,192,64,.06)';
    const x = Math.min(shape.x1, shape.x2);
    const y = Math.min(shape.y1, shape.y2);
    const w = Math.abs(shape.x2 - shape.x1);
    const h = Math.abs(shape.y2 - shape.y1);
    drawCtx.fillRect(x, y, w, h);
    drawCtx.strokeRect(x, y, w, h);
  }
}

document.getElementById('chart-toolbar').addEventListener('click', e => {
  const tool = e.target.closest('.ctool');
  if (!tool) return;
  const t = tool.dataset.tool;

  if (t === 'eraser') {
    drawingLines = [];
    redrawAll();
    return;
  }
  if (t === 'fib') {
    const panel = document.getElementById('fib-panel');
    panel.classList.toggle('show');
    tool.classList.toggle('on');
    return;
  }

  document.querySelectorAll('.ctool').forEach(c => c.classList.remove('on'));
  tool.classList.add('on');
  activeTool = t;
  const container = document.getElementById('tv-chart-container');
  if (container) container.style.cursor = t === 'cursor' ? 'default' : 'crosshair';
});

// Drawing on chart
document.getElementById('tv-chart-container').addEventListener('mousedown', e => {
  if (activeTool === 'cursor') return;
  if (activeTool === 'fib') return;
  const rect = e.currentTarget.getBoundingClientRect();
  drawingStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
  isDrawing = true;
  initDrawCanvas();
});

document.getElementById('tv-chart-container').addEventListener('mousemove', e => {
  if (!isDrawing || !drawingStart) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const x2 = e.clientX - rect.left;
  const y2 = e.clientY - rect.top;
  redrawAll();
  drawShape({ type: activeTool, x1: drawingStart.x, y1: drawingStart.y, x2, y2 }, true);
});

document.getElementById('tv-chart-container').addEventListener('mouseup', e => {
  if (!isDrawing || !drawingStart) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const x2 = e.clientX - rect.left;
  const y2 = e.clientY - rect.top;
  const shape = { type: activeTool, x1: drawingStart.x, y1: drawingStart.y, x2, y2 };
  drawingLines.push(shape);
  redrawAll();
  isDrawing = false;
  drawingStart = null;
});

function toggleExpand() {
  const wrap = document.getElementById('chart-wrap');
  const btn = document.getElementById('expand-btn');
  wrap.classList.toggle('expanded');
  btn.textContent = wrap.classList.contains('expanded') ? 'â¤¡' : 'â¤¢';
  if (lwChart) {
    setTimeout(() => {
      const container = document.getElementById('tv-chart-container');
      lwChart.resize(container.offsetWidth, container.offsetHeight);
      if (drawCanvas) { drawCanvas.width = container.offsetWidth; drawCanvas.height = container.offsetHeight; redrawAll(); }
    }, 300);
  }
}

function calcFib() {
  const high = parseFloat(document.getElementById('fib-high').value);
  const low = parseFloat(document.getElementById('fib-low').value);
  if (isNaN(high) || isNaN(low)) return;
  const diff = high - low;
  const levels = [
    [0, low],
    [0.236, low + diff * 0.236],
    [0.382, low + diff * 0.382],
    [0.5,   low + diff * 0.5],
    [0.618, low + diff * 0.618],
    [0.786, low + diff * 0.786],
    [1,     high],
    [1.618, low + diff * 1.618],
  ];
  const colors = ['#ff4d6d','#f0c040','#0ff0b3','#38bdf8','#0ff0b3','#f0c040','#ff4d6d','#a78bfa'];
  document.getElementById('fib-results').innerHTML = levels.map(([pct, price], i) =>
    `<div class="fib-row"><span class="fib-level" style="color:${colors[i]}">${(pct*100).toFixed(1)}%</span><span class="fib-price">${price.toFixed(2)}</span></div>`
  ).join('');

  // Grafik Ã¼zerinde fib Ã§izgileri Ã§iz
  initDrawCanvas();
  if (!lwChart || !drawCanvas) return;
  const chartH = drawCanvas.height;
  const chartW = drawCanvas.width;
  drawCtx.clearRect(0, 0, chartW, chartH);
  drawingLines = drawingLines.filter(l => l.type !== 'fib_level');

  // Fiyat â†’ Y koordinatÄ± dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (yaklaÅŸÄ±k)
  const priceRange = high - low;
  const padding = chartH * 0.1;
  const usableH = chartH - padding * 2;
  levels.forEach(([pct, price], i) => {
    const y = padding + usableH * (1 - (price - low) / (priceRange * 1.2 + priceRange * 0.1));
    drawingLines.push({ type: 'fib_level', y1: Math.max(5, Math.min(y, chartH-5)), color: colors[i], label: `${(pct*100).toFixed(1)}% ${price.toFixed(1)}` });
  });
  redrawFib();
}

function redrawFib() {
  if (!drawCtx || !drawCanvas) return;
  drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
  drawingLines.forEach(l => {
    if (l.type === 'fib_level') {
      drawCtx.strokeStyle = l.color || 'rgba(240,192,64,.6)';
      drawCtx.lineWidth = 1;
      drawCtx.setLineDash([3, 3]);
      drawCtx.beginPath();
      drawCtx.moveTo(0, l.y1);
      drawCtx.lineTo(drawCanvas.width, l.y1);
      drawCtx.stroke();
      drawCtx.setLineDash([]);
      drawCtx.fillStyle = l.color || '#f0c040';
      drawCtx.font = '8px JetBrains Mono, monospace';
      drawCtx.fillText(l.label, 4, l.y1 - 2);
    } else {
      drawShape(l, false);
    }
  });
}

// Override redrawAll to handle fib levels too
const _origRedraw = redrawAll;
window.redrawAll = function() {
  if (!drawCtx || !drawCanvas) return;
  drawCtx.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
  drawingLines.forEach(l => {
    if (l.type === 'fib_level') {
      drawCtx.strokeStyle = l.color || 'rgba(240,192,64,.6)';
      drawCtx.lineWidth = 1;
      drawCtx.setLineDash([3, 3]);
      drawCtx.beginPath();
      drawCtx.moveTo(0, l.y1);
      drawCtx.lineTo(drawCanvas.width, l.y1);
      drawCtx.stroke();
      drawCtx.setLineDash([]);
      drawCtx.fillStyle = l.color || '#f0c040';
      drawCtx.font = '8px JetBrains Mono, monospace';
      drawCtx.fillText(l.label, 4, l.y1 - 2);
    } else {
      drawShape(l, false);
    }
  });
};

</script>
</body>
</html>
